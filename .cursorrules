# Reglas de Cursor para Whalyze

## Descripci√≥n de la App

Whalyze es una aplicaci√≥n m√≥vil desarrollada en Flutter, dise√±ada para analizar chats exportados de WhatsApp (.txt).
El procesamiento del archivo se realiza 100% en local para garantizar privacidad y rapidez.

La app permite al usuario elegir entre tres modos de an√°lisis:

Wrapped ‚Üí estad√≠sticas visuales, pantallas animadas, res√∫menes estilo "Spotify Wrapped".

Red Flags ‚Üí an√°lisis de comportamientos t√≥xicos, patrones, se√±ales de alerta.

Roast Me ‚Üí an√°lisis humor√≠stico basado en el tono de la conversaci√≥n.

Funciones clave:

Abrir archivos desde WhatsApp mediante ACTION_VIEW o ACTION_SEND.

Mostrar popup al importar archivo con selecci√≥n de modo (Wrapped / Red Flags / Roast).

Procesar miles de mensajes localmente.

Enviar JSON a la API solo si el usuario quiere compartir su Wrapped online.

Mostrar animaciones fluidas entre pantallas (tap-to-continue).

Monetizaci√≥n con anuncios + compras in-app.

üìä Datos clave que se miden en un Wrapped de WhatsApp (resumen)
1. Actividad general del chat

Total de mensajes por persona

Diferencia porcentual entre participantes

D√≠a m√°s activo

Mes m√°s activo

Primer mensaje y fecha de inicio

2. Frecuencia y patrones de conversaci√≥n

Qui√©n inicia m√°s conversaciones

Qui√©n responde m√°s r√°pido

Rachas de mensajes

D√≠as consecutivos escribiendo

Horas del d√≠a con m√°s actividad

D√≠as de la semana m√°s activos

3. Contenido emocional / expresivo

Emojis m√°s usados por cada persona

Interpretaci√≥n del estilo emocional seg√∫n emojis

Palabras m√°s usadas (por longitud o por frecuencia)

4. Hitos y curiosidades

Palabras √∫nicas totales

Preguntas realizadas

Mensajes eliminados y editados

Racha m√°s intensa (explosiones de mensajes)

Dato curioso global (ej.: √≥rbitas, nacimientos, distancias, etc.)

5. Contenido multimedia

Total de fotos, v√≠deos, audios, GIFs y stickers

Fotos temporales

Ubicaciones compartidas

Contactos enviados

6. Comparaciones de comportamiento

Qui√©n mueve m√°s el chat

Qui√©n responde antes

Qui√©n genera m√°s picos de conversaci√≥n

Qui√©n tiene m√°s mensajes largos/cortos

7. Palabras y lenguaje

Palabras m√°s repetidas

Palabras destacadas por longitud

Frases o patrones recurrentes


## Estructura del Proyecto

<!-- Documenta la estructura del proyecto aqu√≠ -->


## Convenciones de C√≥digo

<!-- Define las convenciones de c√≥digo que se deben seguir -->


## Formato de Archivos WhatsApp (.txt)

### Estructura General del Formato

Los archivos exportados de WhatsApp siguen un formato espec√≠fico que debe parsearse correctamente:

```
DD/MM/YY, HH:MM - [Participante]: [Mensaje]
```

### Patr√≥n de Expresi√≥n Regular Base

```regex
^(\d{1,2}/\d{1,2}/\d{2,4}),?\s+(\d{1,2}:\d{2})\s+-\s+([^:]+):\s*(.*)$
```

### Extracci√≥n de Datos

#### 1. Extracci√≥n de Fechas

**Formato:** `DD/MM/YY` o `DD/MM/YYYY`
- Ejemplo: `21/10/25` ‚Üí d√≠a 21, mes 10, a√±o 2025
- Ejemplo: `21/10/2025` ‚Üí d√≠a 21, mes 10, a√±o 2025

**Parsing:**
- Si el a√±o tiene 2 d√≠gitos (YY), a√±adir prefijo "20" ‚Üí `20YY`
- Si el a√±o tiene 4 d√≠gitos (YYYY), usar directamente
- Separar por `/` para obtener d√≠a, mes, a√±o
- Convertir a objeto `DateTime` para c√°lculos temporales

#### 2. Extracci√≥n de Hora

**Formato:** `HH:MM` (24 horas)
- Ejemplo: `8:21` ‚Üí 8:21 AM
- Ejemplo: `14:35` ‚Üí 2:35 PM

**Parsing:**
- Separar por `:` para obtener horas y minutos
- Combinar con fecha para crear `DateTime` completo

#### 3. Extracci√≥n de Nombres de Participantes

**Formato:** Todo el texto entre `-` y `:` es el nombre del participante
- Ejemplo: `21/10/25, 8:21 - Pepe: Mensaje` ‚Üí nombre: `Pepe`
- Ejemplo: `21/10/25, 8:21 - David: Mensaje` ‚Üí nombre: `David`

**Reglas importantes:**
- El nombre puede contener espacios: `Juan P√©rez`
- El nombre puede contener caracteres especiales y emojis
- Trimear espacios al inicio y final del nombre
- Si no hay `:` despu√©s del nombre, NO es un mensaje de usuario (ver excepciones)

#### 4. Extracci√≥n del Contenido del Mensaje

**Formato:** Todo el texto despu√©s de `: ` (dos puntos + espacio)
- Ejemplo: `Pepe: Buenas David` ‚Üí mensaje: `Buenas David`
- El mensaje puede contener m√∫ltiples l√≠neas si contin√∫a en la siguiente l√≠nea sin fecha

**Mensajes multil√≠nea (CR√çTICO):**
- **Regla fundamental:** Si una l√≠nea NO empieza con patr√≥n de fecha (`DD/MM/YY`), entonces es continuaci√≥n del mensaje anterior
- Un mensaje puede extenderse por m√∫ltiples l√≠neas, pero sigue siendo **UN SOLO MENSAJE**
- Concatenar todas las l√≠neas consecutivas sin fecha hasta encontrar una nueva l√≠nea que empiece con patr√≥n de fecha
- Preservar los saltos de l√≠nea (`\n`) al concatenar para mantener el formato original

**Ejemplo de mensaje multil√≠nea:**

```
10/11/25, 10:36 - David: Ruben Gomez Zapater/Carlos Quintilla Faro

Ruben Gomez Zapater: rugoza83@gmail.com - 675263356

Carlos Quintilla Faro: carlos.quintilla@gmail.com - 600906406

Carlos Delgado Torres/Fernando Inglan Bielsa

Carlos Delgado Torres: marcarelecar@gmail.com - 646965654

Fernando Ingl√°n Bielsa: inglan.llorente@hotmail.com - 636411716

10/11/25, 10:36 - David: Los pongo aqui pa no tener que mirar el correo
```

**Parsing correcto:**
- **Mensaje 1:** Todo desde `10/11/25, 10:36 - David: Ruben Gomez...` hasta justo antes de la siguiente fecha
- **Mensaje 2:** `10/11/25, 10:36 - David: Los pongo aqui pa no tener que mirar el correo`
- Total: **2 mensajes** (no contar cada l√≠nea como mensaje separado)

**Algoritmo de detecci√≥n:**
```dart
String currentMessage = '';
DateTime? currentDate;
String? currentParticipant;

for (final line in lines) {
  // Verificar si la l√≠nea empieza con patr√≥n de fecha
  if (messagePattern.hasMatch(line.trim())) {
    // Guardar mensaje anterior si existe
    if (currentMessage.isNotEmpty && currentParticipant != null) {
      saveMessage(currentDate, currentParticipant, currentMessage);
    }
    // Iniciar nuevo mensaje
    final match = messagePattern.firstMatch(line.trim());
    currentDate = parseDate(match.group(1));
    currentParticipant = match.group(3)?.trim();
    currentMessage = match.group(4)?.trim() ?? '';
  } else {
    // Continuaci√≥n del mensaje anterior
    if (currentMessage.isNotEmpty) {
      currentMessage += '\n' + line.trim();
    }
  }
}
// No olvidar guardar el √∫ltimo mensaje
if (currentMessage.isNotEmpty && currentParticipant != null) {
  saveMessage(currentDate, currentParticipant, currentMessage);
}
```

### Excepciones y Casos Especiales

#### 1. Mensajes del Sistema (IGNORAR)

**Patr√≥n:** Mensajes que empiezan con texto espec√≠fico sin nombre de participante

**Ejemplos a ignorar:**
- `21/10/25, 8:21 - Los mensajes y las llamadas est√°n cifrados de extremo a extremo...`
- Cualquier mensaje que empiece con `Los mensajes y las llamadas` debe ser completamente ignorado
- No contar como mensaje v√°lido
- No extraer participante

**Detecci√≥n:**
```dart
if (line.contains('Los mensajes y las llamadas')) {
  // Ignorar completamente esta l√≠nea
  continue;
}
```

#### 2. Notificaciones de Contactos

**Formato:** `DD/MM/YY, HH:MM - ‚Äé[Nombre] es un contacto.`
- Ejemplo: `21/10/25, 8:21 - ‚ÄéPepe es un contacto.`
- No tiene dos puntos despu√©s del nombre
- Puede contener car√°cter invisible al inicio (‚Äé)

**Tratamiento:**
- Opcional: Registrar como evento de sistema (contacto a√±adido)
- No contar como mensaje de texto
- Puede usarse para detectar fecha de inicio de chat

#### 3. Detecci√≥n de Contenido Multimedia

**Indicadores comunes en mensajes:**
- **Im√°genes:** 
  - Texto: `[Imagen omitida]`, `[imagen]`, `image omitted`
  - Texto: `<Multimedia omitido>` ‚Üí **SIEMPRE es una imagen**
  - O simplemente ausencia de texto con patr√≥n de fecha v√°lido
- **Videos:**
  - Texto: `[Video omitido]`, `[video]`, `video omitted`
- **Audios:**
  - Texto: `[Audio]`, `[audio]`, `audio omitted`
  - Puede incluir duraci√≥n: `[Audio] (0:15)`
- **Documentos:**
  - Texto: `[Documento]`, `[document]`, nombre de archivo
- **Ubicaciones:**
  - Texto: `[Ubicaci√≥n]`, `[location]`
- **Contactos:**
  - Texto: `[Contacto]`, `[contact]`
- **Stickers:**
  - Texto: `[Sticker]`, `[sticker]`
- **GIFs:**
  - Texto: `[GIF]`, `[gif]`

**Detecci√≥n:**
```dart
bool isMediaMessage(String message) {
  final mediaPatterns = [
    r'\[.*imagen.*\]',
    r'<Multimedia omitido>',  // Patr√≥n espec√≠fico para im√°genes
    r'\[.*video.*\]',
    r'\[.*audio.*\]',
    r'\[.*documento.*\]',
    r'\[.*ubicaci√≥n.*\]',
    r'\[.*contacto.*\]',
    r'\[.*sticker.*\]',
    r'\[.*gif.*\]',
  ];
  
  final lowerMessage = message.toLowerCase();
  return mediaPatterns.any((pattern) => 
    RegExp(pattern, caseSensitive: false).hasMatch(lowerMessage)
  );
}

// Funci√≥n espec√≠fica para detectar im√°genes
bool isImageMessage(String message) {
  final imagePatterns = [
    r'\[.*imagen.*\]',
    r'<Multimedia omitido>',  // Patr√≥n espec√≠fico: SIEMPRE es imagen
    r'image omitted',
  ];
  
  final lowerMessage = message.toLowerCase();
  return imagePatterns.any((pattern) => 
    RegExp(pattern, caseSensitive: false).hasMatch(lowerMessage)
  );
}
```

#### 4. Mensajes Eliminados

**Formato:** `DD/MM/YY, HH:MM - [Participante]: Este mensaje fue eliminado`
- Variaciones: `Este mensaje fue eliminado`, `This message was deleted`
- Contar como mensaje pero marcar como eliminado

#### 5. Mensajes Editados

**Formato:** `DD/MM/YY, HH:MM - [Participante]: Mensaje (editado)`
- Buscar indicador `(editado)` o `(edited)` al final
- Contar como mensaje normal pero marcar como editado

### Reglas de Parsing

1. **Primera l√≠nea del archivo:**
   - SIEMPRE verificar si empieza con `Los mensajes y las llamadas`
   - Si es as√≠, ignorar completamente

2. **L√≠neas vac√≠as:**
   - Ignorar l√≠neas completamente vac√≠as
   - No afectan el conteo de mensajes

3. **L√≠neas sin patr√≥n de fecha (CR√çTICO - Mensajes multil√≠nea):**
   - **IMPORTANTE:** Si una l√≠nea NO empieza con patr√≥n `DD/MM/YY`, entonces es continuaci√≥n del mensaje anterior
   - Estas l√≠neas forman parte del mismo mensaje, NO son mensajes separados
   - Concatenar todas las l√≠neas consecutivas sin fecha al √∫ltimo mensaje procesado
   - Preservar saltos de l√≠nea (`\n`) al concatenar
   - **Un mensaje puede tener m√∫ltiples l√≠neas pero cuenta como 1 solo mensaje**

4. **Validaci√≥n de mensajes:**
   - Un mensaje v√°lido DEBE tener:
     - Fecha v√°lida (patr√≥n DD/MM/YY)
     - Hora v√°lida (patr√≥n HH:MM)
     - Separador ` - `
     - Nombre de participante (texto antes de `:`)
     - Contenido (texto despu√©s de `: `)

5. **Normalizaci√≥n de nombres:**
   - Eliminar espacios al inicio y final
   - Eliminar caracteres invisibles (como ‚Äé)
   - Mantener may√∫sculas/min√∫sculas originales para identificaci√≥n

### Ejemplo de Parsing Completo

**Ejemplo 1 - Mensajes simples:**

```
Entrada:
21/10/25, 8:21 - Los mensajes y las llamadas est√°n cifrados... [IGNORAR]
21/10/25, 8:21 - ‚ÄéPepe es un contacto. [EVENTO DE SISTEMA]
21/10/25, 8:21 - Pepe: Buenas David [MENSAJE V√ÅLIDO]
21/10/25, 8:21 - Pepe: [Imagen omitida] [MENSAJE MULTIMEDIA]
21/10/25, 8:23 - David: Hola David!! [MENSAJE V√ÅLIDO]
```

**Resultado esperado:**
- Total mensajes v√°lidos: 3 (2 texto, 1 multimedia)
- Participantes: ["Pepe", "David"]
- Primer mensaje: 21/10/25 8:21 (Pepe)
- √öltimo mensaje: 21/10/25 8:23 (David)

**Ejemplo 2 - Mensaje multil√≠nea:**

```
Entrada:
10/11/25, 10:36 - David: Ruben Gomez Zapater/Carlos Quintilla Faro

Ruben Gomez Zapater: rugoza83@gmail.com - 675263356

Carlos Quintilla Faro: carlos.quintilla@gmail.com - 600906406

Carlos Delgado Torres/Fernando Inglan Bielsa

Carlos Delgado Torres: marcarelecar@gmail.com - 646965654

Fernando Ingl√°n Bielsa: inglan.llorente@hotmail.com - 636411716

10/11/25, 10:36 - David: Los pongo aqui pa no tener que mirar el correo
```

**Resultado esperado:**
- Total mensajes v√°lidos: **2** (NO 8, porque las l√≠neas sin fecha son parte del primer mensaje)
- Mensaje 1: Contenido completo desde "Ruben Gomez Zapater..." hasta "636411716" (todo es 1 mensaje)
- Mensaje 2: "Los pongo aqui pa no tener que mirar el correo"
- Participantes: ["David"]

## Notas Importantes

- El procesamiento debe ser robusto ante variaciones en el formato
- Manejar errores de parsing de fecha/hora sin detener el procesamiento completo
- Considerar diferentes idiomas para mensajes del sistema (espa√±ol/ingl√©s principalmente)
- El formato puede variar ligeramente seg√∫n la versi√≥n de WhatsApp y el idioma del dispositivo


